<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>rich.text &#8212; saturnin 0.8.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-2.3.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>

        <a class="brand" href="../../index.html">
          saturnin</a>
        <span class="navbar-text pull-left"><b>0.8.0</b></span>

        <div class="nav-collapse">
          <ul class="nav">
            <li class="divider-vertical"></li>
            
                <li><a href="../../usage-guide.html">Usage Guide</a></li>
                <li><a href="../../py-modindex.html">Modules</a></li>
                <li><a href="../../genindex.html">Index</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Content <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started.html#quick-start-guide">Quick-start Guide</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usage-guide.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Saturnin Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ref-base.html">saturnin.base</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base.html#constants">Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base.html#types">Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base.html#exceptions">Exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base.html#dataclasses">Dataclasses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base.html#globals">Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-base-types.html">saturnin.base.types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-types.html#saturnin-common-type-definitions-and-constants">Saturnin common type definitions and constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-types.html#types-for-annotations">Types for annotations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-types.html#constants">Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-types.html#exceptions">Exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-types.html#sentinels">Sentinels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-types.html#enums">Enums</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-types.html#dataclasses">Dataclasses</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-base-config.html">saturnin.base.config</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-config.html#constants">Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-config.html#globals">Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-config.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-config.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-base-transport.html">saturnin.base.transport</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-transport.html#types-for-type-hints">Types for type hints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-transport.html#constants">Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-transport.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-transport.html#channels-for-individual-0mq-socket-types">Channels for individual 0MQ socket types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-base-component.html">saturnin.base.component</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-component.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-base-component.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-component-controller.html">saturnin.component.controller</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-controller.html#constants-and-variables">Constants and variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-controller.html#functions">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-controller.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-component-micro.html">saturnin.component.micro</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-micro.html#constants-and-variables">Constants and variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-micro.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-component-service.html">saturnin.component.service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-service.html#constants-and-variables">Constants and variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-service.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-component-client.html">saturnin.component.client</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-client.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-component-single.html">saturnin.component.single</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-single.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-component-bundle.html">saturnin.component.bundle</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-bundle.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-component-registry.html">saturnin.component.registry</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-registry.html#globals">Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-registry.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-component-apps.html">saturnin.component.apps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-apps.html#globals">Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-apps.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-component-recipe.html">saturnin.component.recipe</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-recipe.html#enums">Enums</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-component-recipe.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-lib-console.html">saturnin.lib.console</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-lib-console.html#globals">Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-lib-console.html#constants">Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-lib-console.html#functions">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-lib-console.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-lib-daemon.html">saturnin.lib.daemon</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-lib-daemon.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-lib-metadata.html">saturnin.lib.metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-lib-data-onepipe.html">saturnin.lib.data.onepipe</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-lib-data-onepipe.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-lib-data-filter.html">saturnin.lib.data.filter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-lib-data-filter.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-protocol-fbsp.html">saturnin.protocol.fbsp</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-protocol-fbsp.html#constants">Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-protocol-fbsp.html#enums">Enums</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-protocol-fbsp.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-protocol-fbsp.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-protocol-fbdp.html">saturnin.protocol.fbdp</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-protocol-fbdp.html#constants">Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-protocol-fbdp.html#enums">Enums</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-protocol-fbdp.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-protocol-iccp.html">saturnin.protocol.iccp</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-protocol-iccp.html#enums">Enums</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-protocol-iccp.html#classes">Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-svcrun.html">saturnin._scripts.svcrun</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-scripts-svcrun.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-daemon.html">saturnin._scripts.daemon</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-scripts-daemon.html#globals">Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-scripts-daemon.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-bundlerun.html">saturnin._scripts.bundlerun</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-scripts-bundlerun.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-cli.html">saturnin._scripts.cli</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-scripts-cli.html#globals">Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-scripts-cli.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-repl.html">saturnin._scripts.repl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-completers.html">saturnin._scripts.completers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-commands-site.html">saturnin._scripts.commands.site</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-scripts-commands-site.html#globals">Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-scripts-commands-site.html#command-functions">Command functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-commands-pkg.html">saturnin._scripts.commands.pkg</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref-scripts-commands-pkg.html#globals">Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref-scripts-commands-pkg.html#command-functions">Command functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-commands-recipes.html">saturnin._scripts.commands.recipes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-commands-daemons.html">saturnin._scripts.commands.daemons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref-scripts-commands-oids.html">saturnin._scripts.commands.oids</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-7-0">Version 0.7.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-1-0">Version 0.1.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
      </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body span12 content" role="main">
      
  <h1>Source code for rich.text</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">gcd</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">NamedTuple</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">._loop</span> <span class="kn">import</span> <span class="n">loop_last</span>
<span class="kn">from</span> <span class="nn">._pick</span> <span class="kn">import</span> <span class="n">pick_bool</span>
<span class="kn">from</span> <span class="nn">._wrap</span> <span class="kn">import</span> <span class="n">divide_line</span>
<span class="kn">from</span> <span class="nn">.align</span> <span class="kn">import</span> <span class="n">AlignMethod</span>
<span class="kn">from</span> <span class="nn">.cells</span> <span class="kn">import</span> <span class="n">cell_len</span><span class="p">,</span> <span class="n">set_cell_size</span>
<span class="kn">from</span> <span class="nn">.containers</span> <span class="kn">import</span> <span class="n">Lines</span>
<span class="kn">from</span> <span class="nn">.control</span> <span class="kn">import</span> <span class="n">strip_control_codes</span>
<span class="kn">from</span> <span class="nn">.emoji</span> <span class="kn">import</span> <span class="n">EmojiVariant</span>
<span class="kn">from</span> <span class="nn">.jupyter</span> <span class="kn">import</span> <span class="n">JupyterMixin</span>
<span class="kn">from</span> <span class="nn">.measure</span> <span class="kn">import</span> <span class="n">Measurement</span>
<span class="kn">from</span> <span class="nn">.segment</span> <span class="kn">import</span> <span class="n">Segment</span>
<span class="kn">from</span> <span class="nn">.style</span> <span class="kn">import</span> <span class="n">Style</span><span class="p">,</span> <span class="n">StyleType</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span> <span class="nn">.console</span> <span class="kn">import</span> <span class="n">Console</span><span class="p">,</span> <span class="n">ConsoleOptions</span><span class="p">,</span> <span class="n">JustifyMethod</span><span class="p">,</span> <span class="n">OverflowMethod</span>

<span class="n">DEFAULT_JUSTIFY</span><span class="p">:</span> <span class="s2">&quot;JustifyMethod&quot;</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
<span class="n">DEFAULT_OVERFLOW</span><span class="p">:</span> <span class="s2">&quot;OverflowMethod&quot;</span> <span class="o">=</span> <span class="s2">&quot;fold&quot;</span>


<span class="n">_re_whitespace</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+$&quot;</span><span class="p">)</span>

<span class="n">TextType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Text&quot;</span><span class="p">]</span>

<span class="n">GetStyleCallable</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StyleType</span><span class="p">]]</span>


<span class="k">class</span> <span class="nc">Span</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A marked up region in some text.&quot;&quot;&quot;</span>

    <span class="n">start</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Span start index.&quot;&quot;&quot;</span>
    <span class="n">end</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Span end index.&quot;&quot;&quot;</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Style</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Style associated with the span.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Span(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="si">!r}</span><span class="s2">)&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">Style</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">_meta</span><span class="p">)</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Span(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="si">!r}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;Span&quot;</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Span&quot;</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split a span in to 2 from a given offset.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">span1</span> <span class="o">=</span> <span class="n">Span</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">offset</span><span class="p">),</span> <span class="n">style</span><span class="p">)</span>
        <span class="n">span2</span> <span class="o">=</span> <span class="n">Span</span><span class="p">(</span><span class="n">span1</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">span1</span><span class="p">,</span> <span class="n">span2</span>

    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Span&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Move start and end by a given offset.</span>

<span class="sd">        Args:</span>
<span class="sd">            offset (int): Number of characters to add to start and end.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TextSpan: A new TextSpan with adjusted position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">Span</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">right_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Span&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Crop the span at the given offset.</span>

<span class="sd">        Args:</span>
<span class="sd">            offset (int): A value between start and end.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Span: A new (possibly smaller) span.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">Span</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">style</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Text</span><span class="p">(</span><span class="n">JupyterMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Text with color / style.</span>

<span class="sd">    Args:</span>
<span class="sd">        text (str, optional): Default unstyled text. Defaults to &quot;&quot;.</span>
<span class="sd">        style (Union[str, Style], optional): Base style for text. Defaults to &quot;&quot;.</span>
<span class="sd">        justify (str, optional): Justify method: &quot;left&quot;, &quot;center&quot;, &quot;full&quot;, &quot;right&quot;. Defaults to None.</span>
<span class="sd">        overflow (str, optional): Overflow method: &quot;crop&quot;, &quot;fold&quot;, &quot;ellipsis&quot;. Defaults to None.</span>
<span class="sd">        no_wrap (bool, optional): Disable text wrapping, or None for default. Defaults to None.</span>
<span class="sd">        end (str, optional): Character to end text with. Defaults to &quot;\\\\n&quot;.</span>
<span class="sd">        tab_size (int): Number of spaces per tab, or ``None`` to use ``console.tab_size``. Defaults to 8.</span>
<span class="sd">        spans (List[Span], optional). A list of predefined style spans. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;_text&quot;</span><span class="p">,</span>
        <span class="s2">&quot;style&quot;</span><span class="p">,</span>
        <span class="s2">&quot;justify&quot;</span><span class="p">,</span>
        <span class="s2">&quot;overflow&quot;</span><span class="p">,</span>
        <span class="s2">&quot;no_wrap&quot;</span><span class="p">,</span>
        <span class="s2">&quot;end&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tab_size&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_spans&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_length&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Style</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">justify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;JustifyMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overflow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OverflowMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">no_wrap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">tab_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">spans</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Span</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sanitized_text</span> <span class="o">=</span> <span class="n">strip_control_codes</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="p">[</span><span class="n">sanitized_text</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">justify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;JustifyMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">justify</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overflow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OverflowMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overflow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_wrap</span> <span class="o">=</span> <span class="n">no_wrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tab_size</span> <span class="o">=</span> <span class="n">tab_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Span</span><span class="p">]</span> <span class="o">=</span> <span class="n">spans</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sanitized_text</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_length</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;text </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="si">!r}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Text</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">plain</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_spans</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">other</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Text</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">plain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">slice</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">get_text_at</span><span class="p">(</span><span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
            <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span>
                <span class="n">spans</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">_Span</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span>
                    <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">start</span>
                <span class="p">],</span>
                <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">text</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">get_text_at</span><span class="p">(</span><span class="nb">slice</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="nb">slice</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This would be a bit of work to implement efficiently</span>
                <span class="c1"># For now, its not required</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;slices with step!=1 are not supported&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cell_len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of cells required to render this text.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cell_len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">markup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get console markup to render this Text.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string potentially creating markup tags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.markup</span> <span class="kn">import</span> <span class="n">escape</span>

        <span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">plain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span>
        <span class="n">markup_spans</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">),</span>
            <span class="o">*</span><span class="p">((</span><span class="n">span</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">style</span><span class="p">)</span> <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">),</span>
            <span class="o">*</span><span class="p">((</span><span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">style</span><span class="p">)</span> <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">),</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plain</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">markup_spans</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">append</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">closing</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">markup_spans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">position</span><span class="p">:</span>
                <span class="n">append</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">plain</span><span class="p">[</span><span class="n">position</span><span class="p">:</span><span class="n">offset</span><span class="p">]))</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">offset</span>
            <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
                <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[/</span><span class="si">{</span><span class="n">style</span><span class="si">}</span><span class="s2">]&quot;</span> <span class="k">if</span> <span class="n">closing</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">style</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">markup</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">markup</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_markup</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Style</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">emoji</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">emoji_variant</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EmojiVariant</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">justify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;JustifyMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overflow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OverflowMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Text instance from markup.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): A string containing console markup.</span>
<span class="sd">            emoji (bool, optional): Also render emoji code. Defaults to True.</span>
<span class="sd">            justify (str, optional): Justify method: &quot;left&quot;, &quot;center&quot;, &quot;full&quot;, &quot;right&quot;. Defaults to None.</span>
<span class="sd">            overflow (str, optional): Overflow method: &quot;crop&quot;, &quot;fold&quot;, &quot;ellipsis&quot;. Defaults to None.</span>
<span class="sd">            end (str, optional): Character to end text with. Defaults to &quot;\\\\n&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Text: A Text instance with markup rendered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.markup</span> <span class="kn">import</span> <span class="n">render</span>

        <span class="n">rendered_text</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">emoji</span><span class="o">=</span><span class="n">emoji</span><span class="p">,</span> <span class="n">emoji_variant</span><span class="o">=</span><span class="n">emoji_variant</span><span class="p">)</span>
        <span class="n">rendered_text</span><span class="o">.</span><span class="n">justify</span> <span class="o">=</span> <span class="n">justify</span>
        <span class="n">rendered_text</span><span class="o">.</span><span class="n">overflow</span> <span class="o">=</span> <span class="n">overflow</span>
        <span class="n">rendered_text</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">return</span> <span class="n">rendered_text</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_ansi</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Style</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">justify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;JustifyMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overflow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OverflowMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">no_wrap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">tab_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Text object from a string containing ANSI escape codes.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): A string containing escape codes.</span>
<span class="sd">            style (Union[str, Style], optional): Base style for text. Defaults to &quot;&quot;.</span>
<span class="sd">            justify (str, optional): Justify method: &quot;left&quot;, &quot;center&quot;, &quot;full&quot;, &quot;right&quot;. Defaults to None.</span>
<span class="sd">            overflow (str, optional): Overflow method: &quot;crop&quot;, &quot;fold&quot;, &quot;ellipsis&quot;. Defaults to None.</span>
<span class="sd">            no_wrap (bool, optional): Disable text wrapping, or None for default. Defaults to None.</span>
<span class="sd">            end (str, optional): Character to end text with. Defaults to &quot;\\\\n&quot;.</span>
<span class="sd">            tab_size (int): Number of spaces per tab, or ``None`` to use ``console.tab_size``. Defaults to 8.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.ansi</span> <span class="kn">import</span> <span class="n">AnsiDecoder</span>

        <span class="n">joiner</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">justify</span><span class="o">=</span><span class="n">justify</span><span class="p">,</span>
            <span class="n">overflow</span><span class="o">=</span><span class="n">overflow</span><span class="p">,</span>
            <span class="n">no_wrap</span><span class="o">=</span><span class="n">no_wrap</span><span class="p">,</span>
            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
            <span class="n">tab_size</span><span class="o">=</span><span class="n">tab_size</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">decoder</span> <span class="o">=</span> <span class="n">AnsiDecoder</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">joiner</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">styled</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">StyleType</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">justify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;JustifyMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overflow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OverflowMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a Text instance with a pre-applied styled. A style applied in this way won&#39;t be used</span>
<span class="sd">        to pad the text when it is justified.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): A string containing console markup.</span>
<span class="sd">            style (Union[str, Style]): Style to apply to the text. Defaults to &quot;&quot;.</span>
<span class="sd">            justify (str, optional): Justify method: &quot;left&quot;, &quot;center&quot;, &quot;full&quot;, &quot;right&quot;. Defaults to None.</span>
<span class="sd">            overflow (str, optional): Overflow method: &quot;crop&quot;, &quot;fold&quot;, &quot;ellipsis&quot;. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Text: A text instance with a style applied to the entire string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">styled_text</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="n">justify</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="n">overflow</span><span class="p">)</span>
        <span class="n">styled_text</span><span class="o">.</span><span class="n">stylize</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">styled_text</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="o">*</span><span class="n">parts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Text&quot;</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">StyleType</span><span class="p">]],</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Style</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">justify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;JustifyMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overflow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OverflowMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">no_wrap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">tab_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a text instance by combining a sequence of strings with optional styles.</span>
<span class="sd">        The positional arguments should be either strings, or a tuple of string + style.</span>

<span class="sd">        Args:</span>
<span class="sd">            style (Union[str, Style], optional): Base style for text. Defaults to &quot;&quot;.</span>
<span class="sd">            justify (str, optional): Justify method: &quot;left&quot;, &quot;center&quot;, &quot;full&quot;, &quot;right&quot;. Defaults to None.</span>
<span class="sd">            overflow (str, optional): Overflow method: &quot;crop&quot;, &quot;fold&quot;, &quot;ellipsis&quot;. Defaults to None.</span>
<span class="sd">            end (str, optional): Character to end text with. Defaults to &quot;\\\\n&quot;.</span>
<span class="sd">            tab_size (int): Number of spaces per tab, or ``None`` to use ``console.tab_size``. Defaults to 8.</span>
<span class="sd">            meta (Dict[str, Any], optional). Meta data to apply to text, or None for no meta data. Default to None</span>

<span class="sd">        Returns:</span>
<span class="sd">            Text: A new text instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
            <span class="n">justify</span><span class="o">=</span><span class="n">justify</span><span class="p">,</span>
            <span class="n">overflow</span><span class="o">=</span><span class="n">overflow</span><span class="p">,</span>
            <span class="n">no_wrap</span><span class="o">=</span><span class="n">no_wrap</span><span class="p">,</span>
            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
            <span class="n">tab_size</span><span class="o">=</span><span class="n">tab_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">append</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">append</span>
        <span class="n">_Text</span> <span class="o">=</span> <span class="n">Text</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="p">(</span><span class="n">_Text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">append</span><span class="p">(</span><span class="o">*</span><span class="n">part</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
            <span class="n">text</span><span class="o">.</span><span class="n">apply_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the text as a single string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@plain</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">plain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the text to a new value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_text</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">:</span>
            <span class="n">sanitized_text</span> <span class="o">=</span> <span class="n">strip_control_codes</span><span class="p">(</span><span class="n">new_text</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sanitized_text</span><span class="p">]</span>
            <span class="n">old_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sanitized_text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_trim_spans</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spans</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Span</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a reference to the internal list of spans.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span>

    <span class="nd">@spans</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">spans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Span</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set spans.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span> <span class="o">=</span> <span class="n">spans</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">blank_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a new Text instance with copied meta data (but not the string or spans).&quot;&quot;&quot;</span>
        <span class="n">copy_self</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span>
            <span class="n">plain</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span>
            <span class="n">justify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">justify</span><span class="p">,</span>
            <span class="n">overflow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">overflow</span><span class="p">,</span>
            <span class="n">no_wrap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">no_wrap</span><span class="p">,</span>
            <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
            <span class="n">tab_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tab_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">copy_self</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a copy of this instance.&quot;&quot;&quot;</span>
        <span class="n">copy_self</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span>
            <span class="n">justify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">justify</span><span class="p">,</span>
            <span class="n">overflow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">overflow</span><span class="p">,</span>
            <span class="n">no_wrap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">no_wrap</span><span class="p">,</span>
            <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
            <span class="n">tab_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tab_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">copy_self</span><span class="o">.</span><span class="n">_spans</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span>
        <span class="k">return</span> <span class="n">copy_self</span>

    <span class="k">def</span> <span class="nf">stylize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Style</span><span class="p">],</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply a style to the text, or a portion of the text.</span>

<span class="sd">        Args:</span>
<span class="sd">            style (Union[str, Style]): Style instance or style definition to apply.</span>
<span class="sd">            start (int): Start offset (negative indexing is supported). Defaults to 0.</span>
<span class="sd">            end (Optional[int], optional): End offset (negative indexing is supported), or None for end of text. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">start</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">length</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">end</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">length</span> <span class="ow">or</span> <span class="n">end</span> <span class="o">&lt;=</span> <span class="n">start</span><span class="p">:</span>
                <span class="c1"># Span not in text or not valid</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Span</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">style</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">stylize_before</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Style</span><span class="p">],</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply a style to the text, or a portion of the text. Styles will be applied before other styles already present.</span>

<span class="sd">        Args:</span>
<span class="sd">            style (Union[str, Style]): Style instance or style definition to apply.</span>
<span class="sd">            start (int): Start offset (negative indexing is supported). Defaults to 0.</span>
<span class="sd">            end (Optional[int], optional): End offset (negative indexing is supported), or None for end of text. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">start</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">length</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">end</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">length</span> <span class="ow">or</span> <span class="n">end</span> <span class="o">&lt;=</span> <span class="n">start</span><span class="p">:</span>
                <span class="c1"># Span not in text or not valid</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Span</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">style</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">apply_meta</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply meta data to the text, or a portion of the text.</span>

<span class="sd">        Args:</span>
<span class="sd">            meta (Dict[str, Any]): A dict of meta information.</span>
<span class="sd">            start (int): Start offset (negative indexing is supported). Defaults to 0.</span>
<span class="sd">            end (Optional[int], optional): End offset (negative indexing is supported), or None for end of text. Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">Style</span><span class="o">.</span><span class="n">from_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stylize</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">handlers</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply event handlers (used by Textual project).</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from rich.text import Text</span>
<span class="sd">            &gt;&gt;&gt; text = Text(&quot;hello world&quot;)</span>
<span class="sd">            &gt;&gt;&gt; text.on(click=&quot;view.toggle(&#39;world&#39;)&quot;)</span>

<span class="sd">        Args:</span>
<span class="sd">            meta (Dict[str, Any]): Mapping of meta information.</span>
<span class="sd">            **handlers: Keyword args are prefixed with &quot;@&quot; to defined handlers.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Text: Self is returned to method may be chained.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">meta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">meta</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">handlers</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stylize</span><span class="p">(</span><span class="n">Style</span><span class="o">.</span><span class="n">from_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">remove_suffix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a suffix if it exists.</span>

<span class="sd">        Args:</span>
<span class="sd">            suffix (str): Suffix to remove.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right_crop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_style_at_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">console</span><span class="p">:</span> <span class="s2">&quot;Console&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Style</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the style of a character at give offset.</span>

<span class="sd">        Args:</span>
<span class="sd">            console (~Console): Console where text will be rendered.</span>
<span class="sd">            offset (int): Offset in to text (negative indexing supported)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Style: A Style instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: This is a little inefficient, it is only used by full justify</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">get_style</span> <span class="o">=</span> <span class="n">console</span><span class="o">.</span><span class="n">get_style</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">get_style</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">span_style</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">:</span>
                <span class="n">style</span> <span class="o">+=</span> <span class="n">get_style</span><span class="p">(</span><span class="n">span_style</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">style</span>

    <span class="k">def</span> <span class="nf">highlight_regex</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">re_highlight</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">GetStyleCallable</span><span class="p">,</span> <span class="n">StyleType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">style_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Highlight text with a regular expression, where group names are</span>
<span class="sd">        translated to styles.</span>

<span class="sd">        Args:</span>
<span class="sd">            re_highlight (str): A regular expression.</span>
<span class="sd">            style (Union[GetStyleCallable, StyleType]): Optional style to apply to whole match, or a callable</span>
<span class="sd">                which accepts the matched text and returns a style. Defaults to None.</span>
<span class="sd">            style_prefix (str, optional): Optional prefix to add to style group names.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Number of regex matches</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">append_span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">append</span>
        <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>
        <span class="n">plain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">re_highlight</span><span class="p">,</span> <span class="n">plain</span><span class="p">):</span>
            <span class="n">get_span</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span>
            <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">get_span</span><span class="p">()</span>
                <span class="n">match_style</span> <span class="o">=</span> <span class="n">style</span><span class="p">(</span><span class="n">plain</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span> <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">style</span><span class="p">)</span> <span class="k">else</span> <span class="n">style</span>
                <span class="k">if</span> <span class="n">match_style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                    <span class="n">append_span</span><span class="p">(</span><span class="n">_Span</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">match_style</span><span class="p">))</span>

            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">get_span</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                    <span class="n">append_span</span><span class="p">(</span><span class="n">_Span</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">style_prefix</span><span class="si">}{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">count</span>

    <span class="k">def</span> <span class="nf">highlight_words</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">words</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Style</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">case_sensitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Highlight words with a style.</span>

<span class="sd">        Args:</span>
<span class="sd">            words (Iterable[str]): Worlds to highlight.</span>
<span class="sd">            style (Union[str, Style]): Style to apply.</span>
<span class="sd">            case_sensitive (bool, optional): Enable case sensitive matchings. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Number of words highlighted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">re_words</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
        <span class="n">add_span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">append</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span>
            <span class="n">re_words</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">case_sensitive</span> <span class="k">else</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
        <span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">add_span</span><span class="p">(</span><span class="n">_Span</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span><span class="p">))</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span>

    <span class="k">def</span> <span class="nf">rstrip</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Strip whitespace from end of text.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rstrip_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove whitespace beyond a certain width at the end of the text.</span>

<span class="sd">        Args:</span>
<span class="sd">            size (int): The desired size of the text.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text_length</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">excess</span> <span class="o">=</span> <span class="n">text_length</span> <span class="o">-</span> <span class="n">size</span>
            <span class="n">whitespace_match</span> <span class="o">=</span> <span class="n">_re_whitespace</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">whitespace_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">whitespace_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">whitespace_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">right_crop</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">whitespace_count</span><span class="p">,</span> <span class="n">excess</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set new length of the text, clipping or padding is required.&quot;&quot;&quot;</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="n">new_length</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">new_length</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pad_right</span><span class="p">(</span><span class="n">new_length</span> <span class="o">-</span> <span class="n">length</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">right_crop</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">new_length</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rich_console__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">console</span><span class="p">:</span> <span class="s2">&quot;Console&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="s2">&quot;ConsoleOptions&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Segment</span><span class="p">]:</span>
        <span class="n">tab_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">console</span><span class="o">.</span><span class="n">tab_size</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab_size</span> <span class="ow">or</span> <span class="mi">8</span>
        <span class="n">justify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">justify</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">justify</span> <span class="ow">or</span> <span class="n">DEFAULT_JUSTIFY</span>

        <span class="n">overflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overflow</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">overflow</span> <span class="ow">or</span> <span class="n">DEFAULT_OVERFLOW</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span>
            <span class="n">console</span><span class="p">,</span>
            <span class="n">options</span><span class="o">.</span><span class="n">max_width</span><span class="p">,</span>
            <span class="n">justify</span><span class="o">=</span><span class="n">justify</span><span class="p">,</span>
            <span class="n">overflow</span><span class="o">=</span><span class="n">overflow</span><span class="p">,</span>
            <span class="n">tab_size</span><span class="o">=</span><span class="n">tab_size</span> <span class="ow">or</span> <span class="mi">8</span><span class="p">,</span>
            <span class="n">no_wrap</span><span class="o">=</span><span class="n">pick_bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_wrap</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">no_wrap</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">all_lines</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">all_lines</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">console</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rich_measure__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">console</span><span class="p">:</span> <span class="s2">&quot;Console&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="s2">&quot;ConsoleOptions&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Measurement</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">max_text_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cell_len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">lines</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">min_text_width</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">cell_len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span> <span class="k">if</span> <span class="n">words</span> <span class="k">else</span> <span class="n">max_text_width</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Measurement</span><span class="p">(</span><span class="n">min_text_width</span><span class="p">,</span> <span class="n">max_text_width</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">console</span><span class="p">:</span> <span class="s2">&quot;Console&quot;</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Segment&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render the text as Segments.</span>

<span class="sd">        Args:</span>
<span class="sd">            console (Console): Console instance.</span>
<span class="sd">            end (Optional[str], optional): Optional end character.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Iterable[Segment]: Result of render that may be written to the console.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_Segment</span> <span class="o">=</span> <span class="n">Segment</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Segment</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">_Segment</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">get_style</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">console</span><span class="o">.</span><span class="n">get_style</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Style</span><span class="o">.</span><span class="n">null</span><span class="p">())</span>

        <span class="n">enumerated_spans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">style_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="p">:</span> <span class="n">get_style</span><span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">style</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">enumerated_spans</span><span class="p">}</span>
        <span class="n">style_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_style</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>

        <span class="n">spans</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="o">*</span><span class="p">((</span><span class="n">span</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">enumerated_spans</span><span class="p">),</span>
            <span class="o">*</span><span class="p">((</span><span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">enumerated_spans</span><span class="p">),</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">spans</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">stack</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stack_append</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">append</span>
        <span class="n">stack_pop</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">remove</span>

        <span class="n">style_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Style</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Style</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">style_cache_get</span> <span class="o">=</span> <span class="n">style_cache</span><span class="o">.</span><span class="n">get</span>
        <span class="n">combine</span> <span class="o">=</span> <span class="n">Style</span><span class="o">.</span><span class="n">combine</span>

        <span class="k">def</span> <span class="nf">get_current_style</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Style</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Construct current style from stack.&quot;&quot;&quot;</span>
            <span class="n">styles</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">style_map</span><span class="p">[</span><span class="n">_style_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">_style_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>
            <span class="n">cached_style</span> <span class="o">=</span> <span class="n">style_cache_get</span><span class="p">(</span><span class="n">styles</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached_style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cached_style</span>
            <span class="n">current_style</span> <span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">styles</span><span class="p">)</span>
            <span class="n">style_cache</span><span class="p">[</span><span class="n">styles</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_style</span>
            <span class="k">return</span> <span class="n">current_style</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">leaving</span><span class="p">,</span> <span class="n">style_id</span><span class="p">),</span> <span class="p">(</span><span class="n">next_offset</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spans</span><span class="p">,</span> <span class="n">spans</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">if</span> <span class="n">leaving</span><span class="p">:</span>
                <span class="n">stack_pop</span><span class="p">(</span><span class="n">style_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack_append</span><span class="p">(</span><span class="n">style_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">next_offset</span> <span class="o">&gt;</span> <span class="n">offset</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">_Segment</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">next_offset</span><span class="p">],</span> <span class="n">get_current_style</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">_Segment</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Text&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Join text together with this instance as the separator.</span>

<span class="sd">        Args:</span>
<span class="sd">            lines (Iterable[Text]): An iterable of Text instances to join.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Text: A new text instance containing join text.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">new_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blank_copy</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">iter_text</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Text&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">last</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">loop_last</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">line</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">lines</span>

        <span class="n">extend_text</span> <span class="o">=</span> <span class="n">new_text</span><span class="o">.</span><span class="n">_text</span><span class="o">.</span><span class="n">extend</span>
        <span class="n">append_span</span> <span class="o">=</span> <span class="n">new_text</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">append</span>
        <span class="n">extend_spans</span> <span class="o">=</span> <span class="n">new_text</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">extend</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>

        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">iter_text</span><span class="p">():</span>
            <span class="n">extend_text</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">_text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">style</span><span class="p">:</span>
                <span class="n">append_span</span><span class="p">(</span><span class="n">_Span</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">text</span><span class="o">.</span><span class="n">style</span><span class="p">))</span>
            <span class="n">extend_spans</span><span class="p">(</span>
                <span class="n">_Span</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">start</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">_spans</span>
            <span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">new_text</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="k">return</span> <span class="n">new_text</span>

    <span class="k">def</span> <span class="nf">expand_tabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tab_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts tabs to spaces.</span>

<span class="sd">        Args:</span>
<span class="sd">            tab_size (int, optional): Size of tabs. Defaults to 8.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">tab_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tab_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab_size</span>
        <span class="k">assert</span> <span class="n">tab_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blank_copy</span><span class="p">()</span>
        <span class="n">append</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span>

        <span class="n">_style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">include_separator</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">include_separator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">plain</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="n">part</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">plain</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">]</span>
                    <span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
                    <span class="n">pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
                    <span class="n">spaces</span> <span class="o">=</span> <span class="n">tab_size</span> <span class="o">-</span> <span class="p">((</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">tab_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">spaces</span><span class="p">:</span>
                        <span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">spaces</span><span class="p">,</span> <span class="n">_style</span><span class="p">)</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="n">spaces</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">plain</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_spans</span>

    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">overflow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OverflowMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pad</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Truncate text if it is longer that a given width.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_width (int): Maximum number of characters in text.</span>
<span class="sd">            overflow (str, optional): Overflow method: &quot;crop&quot;, &quot;fold&quot;, or &quot;ellipsis&quot;. Defaults to None, to use self.overflow.</span>
<span class="sd">            pad (bool, optional): Pad with spaces if the length is less than max_width. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_overflow</span> <span class="o">=</span> <span class="n">overflow</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overflow</span> <span class="ow">or</span> <span class="n">DEFAULT_OVERFLOW</span>
        <span class="k">if</span> <span class="n">_overflow</span> <span class="o">!=</span> <span class="s2">&quot;ignore&quot;</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">cell_len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">max_width</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_overflow</span> <span class="o">==</span> <span class="s2">&quot;ellipsis&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plain</span> <span class="o">=</span> <span class="n">set_cell_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">,</span> <span class="n">max_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plain</span> <span class="o">=</span> <span class="n">set_cell_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">,</span> <span class="n">max_width</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pad</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">max_width</span><span class="p">:</span>
                <span class="n">spaces</span> <span class="o">=</span> <span class="n">max_width</span> <span class="o">-</span> <span class="n">length</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="si">}{</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">spaces</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_trim_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove or modify any spans that are over the end of the text.&quot;&quot;&quot;</span>
        <span class="n">max_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>
        <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">span</span>
                <span class="k">if</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">max_offset</span>
                <span class="k">else</span> <span class="n">_Span</span><span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_offset</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">),</span> <span class="n">span</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span>
            <span class="k">if</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">max_offset</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pad left and right with a given number of characters.</span>

<span class="sd">        Args:</span>
<span class="sd">            count (int): Width of padding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">character</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Character must be a string of length 1&quot;</span>
        <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
            <span class="n">pad_characters</span> <span class="o">=</span> <span class="n">character</span> <span class="o">*</span> <span class="n">count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plain</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pad_characters</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="si">}{</span><span class="n">pad_characters</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_Span</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span>
            <span class="p">]</span>

    <span class="k">def</span> <span class="nf">pad_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pad the left with a given character.</span>

<span class="sd">        Args:</span>
<span class="sd">            count (int): Number of characters to pad.</span>
<span class="sd">            character (str, optional): Character to pad with. Defaults to &quot; &quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">character</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Character must be a string of length 1&quot;</span>
        <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plain</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">character</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">count</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_Span</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span>
            <span class="p">]</span>

    <span class="k">def</span> <span class="nf">pad_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pad the right with a given character.</span>

<span class="sd">        Args:</span>
<span class="sd">            count (int): Number of characters to pad.</span>
<span class="sd">            character (str, optional): Character to pad with. Defaults to &quot; &quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">character</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Character must be a string of length 1&quot;</span>
        <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plain</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="si">}{</span><span class="n">character</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">align</span><span class="p">:</span> <span class="n">AlignMethod</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Align text to a given width.</span>

<span class="sd">        Args:</span>
<span class="sd">            align (AlignMethod): One of &quot;left&quot;, &quot;center&quot;, or &quot;right&quot;.</span>
<span class="sd">            width (int): Desired width.</span>
<span class="sd">            character (str, optional): Character to pad with. Defaults to &quot; &quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="n">excess_space</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">cell_len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">excess_space</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">align</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pad_right</span><span class="p">(</span><span class="n">excess_space</span><span class="p">,</span> <span class="n">character</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">align</span> <span class="o">==</span> <span class="s2">&quot;center&quot;</span><span class="p">:</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">excess_space</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pad_left</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">character</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pad_right</span><span class="p">(</span><span class="n">excess_space</span> <span class="o">-</span> <span class="n">left</span><span class="p">,</span> <span class="n">character</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pad_left</span><span class="p">(</span><span class="n">excess_space</span><span class="p">,</span> <span class="n">character</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Text&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Style&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add text with an optional style.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (Union[Text, str]): A str or Text to append.</span>
<span class="sd">            style (str, optional): A style name. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Text: Returns self for chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only str or Text can be appended to Text&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">sanitized_text</span> <span class="o">=</span> <span class="n">strip_control_codes</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sanitized_text</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">text_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sanitized_text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Span</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">text_length</span><span class="p">,</span> <span class="n">style</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">+=</span> <span class="n">text_length</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Text</span><span class="p">):</span>
                <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>
                <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;style must not be set when appending Text instance&quot;</span>
                    <span class="p">)</span>
                <span class="n">text_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span>
                <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">_Span</span><span class="p">(</span><span class="n">text_length</span><span class="p">,</span> <span class="n">text_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">text</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">_Span</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">text_length</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="n">text_length</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">_spans</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">append_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="s2">&quot;Text&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append another Text instance. This method is more performant that Text.append, but</span>
<span class="sd">        only works for Text.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Text: Returns self for chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>
        <span class="n">text_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span>
        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Span</span><span class="p">(</span><span class="n">text_length</span><span class="p">,</span> <span class="n">text_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">text</span><span class="o">.</span><span class="n">style</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">_Span</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">text_length</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="n">text_length</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">_spans</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">append_tokens</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StyleType</span><span class="p">]]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append iterable of str and style. Style may be a Style instance or a str style definition.</span>

<span class="sd">        Args:</span>
<span class="sd">            pairs (Iterable[Tuple[str, Optional[StyleType]]]): An iterable of tuples containing str content and style.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Text: Returns self for chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">append_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="o">.</span><span class="n">append</span>
        <span class="n">append_span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">append</span>
        <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">content</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">append_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">append_span</span><span class="p">(</span><span class="n">_Span</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">style</span><span class="p">))</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">copy_styles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="s2">&quot;Text&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy styles from another Text instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (Text): A Text instance to copy styles from, must be the same length.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">_spans</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_separator</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">allow_blank</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lines</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split rich text in to lines, preserving styles.</span>

<span class="sd">        Args:</span>
<span class="sd">            separator (str, optional): String to split on. Defaults to &quot;\\\\n&quot;.</span>
<span class="sd">            include_separator (bool, optional): Include the separator in the lines. Defaults to False.</span>
<span class="sd">            allow_blank (bool, optional): Return a blank line if the text ends with a separator. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[RichText]: A list of rich text, one per line of the original.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">separator</span><span class="p">,</span> <span class="s2">&quot;separator must not be empty&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span>
        <span class="k">if</span> <span class="n">separator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Lines</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()])</span>

        <span class="k">if</span> <span class="n">include_separator</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                <span class="k">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">flatten_spans</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">),</span> <span class="n">text</span><span class="p">):</span>
                    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
                    <span class="k">yield</span> <span class="n">start</span>
                    <span class="k">yield</span> <span class="n">end</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">(</span>
                <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">flatten_spans</span><span class="p">())</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">plain</span> <span class="o">!=</span> <span class="n">separator</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_blank</span> <span class="ow">and</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">separator</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">divide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offsets</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Lines</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Divide text in to a number of lines at given offsets.</span>

<span class="sd">        Args:</span>
<span class="sd">            offsets (Iterable[int]): Offsets used to divide text.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Lines: New RichText instances between offsets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_offsets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_offsets</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Lines</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()])</span>

        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span>
        <span class="n">text_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">divide_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">_offsets</span><span class="p">,</span> <span class="n">text_length</span><span class="p">]</span>
        <span class="n">line_ranges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">divide_offsets</span><span class="p">,</span> <span class="n">divide_offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span>
        <span class="n">justify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">justify</span>
        <span class="n">overflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overflow</span>
        <span class="n">_Text</span> <span class="o">=</span> <span class="n">Text</span>
        <span class="n">new_lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">(</span>
            <span class="n">_Text</span><span class="p">(</span>
                <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span>
                <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
                <span class="n">justify</span><span class="o">=</span><span class="n">justify</span><span class="p">,</span>
                <span class="n">overflow</span><span class="o">=</span><span class="n">overflow</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">line_ranges</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_lines</span>

        <span class="n">_line_appends</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">_spans</span><span class="o">.</span><span class="n">append</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="o">.</span><span class="n">_lines</span><span class="p">]</span>
        <span class="n">line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_ranges</span><span class="p">)</span>
        <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>

        <span class="k">for</span> <span class="n">span_start</span><span class="p">,</span> <span class="n">span_end</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">:</span>

            <span class="n">lower_bound</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">line_count</span>
            <span class="n">start_line_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_bound</span> <span class="o">+</span> <span class="n">upper_bound</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line_start</span><span class="p">,</span> <span class="n">line_end</span> <span class="o">=</span> <span class="n">line_ranges</span><span class="p">[</span><span class="n">start_line_no</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">span_start</span> <span class="o">&lt;</span> <span class="n">line_start</span><span class="p">:</span>
                    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">start_line_no</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">span_start</span> <span class="o">&gt;</span> <span class="n">line_end</span><span class="p">:</span>
                    <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">start_line_no</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">start_line_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_bound</span> <span class="o">+</span> <span class="n">upper_bound</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

            <span class="k">if</span> <span class="n">span_end</span> <span class="o">&lt;</span> <span class="n">line_end</span><span class="p">:</span>
                <span class="n">end_line_no</span> <span class="o">=</span> <span class="n">start_line_no</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_line_no</span> <span class="o">=</span> <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">start_line_no</span>
                <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">line_count</span>

                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">line_start</span><span class="p">,</span> <span class="n">line_end</span> <span class="o">=</span> <span class="n">line_ranges</span><span class="p">[</span><span class="n">end_line_no</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">span_end</span> <span class="o">&lt;</span> <span class="n">line_start</span><span class="p">:</span>
                        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">end_line_no</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">span_end</span> <span class="o">&gt;</span> <span class="n">line_end</span><span class="p">:</span>
                        <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">end_line_no</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">end_line_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_bound</span> <span class="o">+</span> <span class="n">upper_bound</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

            <span class="k">for</span> <span class="n">line_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_line_no</span><span class="p">,</span> <span class="n">end_line_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">line_start</span><span class="p">,</span> <span class="n">line_end</span> <span class="o">=</span> <span class="n">line_ranges</span><span class="p">[</span><span class="n">line_no</span><span class="p">]</span>
                <span class="n">new_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">span_start</span> <span class="o">-</span> <span class="n">line_start</span><span class="p">)</span>
                <span class="n">new_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">span_end</span> <span class="o">-</span> <span class="n">line_start</span><span class="p">,</span> <span class="n">line_end</span> <span class="o">-</span> <span class="n">line_start</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_end</span> <span class="o">&gt;</span> <span class="n">new_start</span><span class="p">:</span>
                    <span class="n">_line_appends</span><span class="p">[</span><span class="n">line_no</span><span class="p">](</span><span class="n">_Span</span><span class="p">(</span><span class="n">new_start</span><span class="p">,</span> <span class="n">new_end</span><span class="p">,</span> <span class="n">style</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new_lines</span>

    <span class="k">def</span> <span class="nf">right_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a number of characters from the end of the text.&quot;&quot;&quot;</span>
        <span class="n">max_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span> <span class="o">-</span> <span class="n">amount</span>
        <span class="n">_Span</span> <span class="o">=</span> <span class="n">Span</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">span</span>
                <span class="k">if</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">max_offset</span>
                <span class="k">else</span> <span class="n">_Span</span><span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_offset</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">),</span> <span class="n">span</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span>
            <span class="k">if</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">max_offset</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">[:</span><span class="o">-</span><span class="n">amount</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">-=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">console</span><span class="p">:</span> <span class="s2">&quot;Console&quot;</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">justify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;JustifyMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overflow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OverflowMethod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tab_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">no_wrap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lines</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Word wrap the text.</span>

<span class="sd">        Args:</span>
<span class="sd">            console (Console): Console instance.</span>
<span class="sd">            width (int): Number of characters per line.</span>
<span class="sd">            emoji (bool, optional): Also render emoji code. Defaults to True.</span>
<span class="sd">            justify (str, optional): Justify method: &quot;default&quot;, &quot;left&quot;, &quot;center&quot;, &quot;full&quot;, &quot;right&quot;. Defaults to &quot;default&quot;.</span>
<span class="sd">            overflow (str, optional): Overflow method: &quot;crop&quot;, &quot;fold&quot;, or &quot;ellipsis&quot;. Defaults to None.</span>
<span class="sd">            tab_size (int, optional): Default tab size. Defaults to 8.</span>
<span class="sd">            no_wrap (bool, optional): Disable wrapping, Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Lines: Number of lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrap_justify</span> <span class="o">=</span> <span class="n">justify</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">justify</span> <span class="ow">or</span> <span class="n">DEFAULT_JUSTIFY</span>
        <span class="n">wrap_overflow</span> <span class="o">=</span> <span class="n">overflow</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overflow</span> <span class="ow">or</span> <span class="n">DEFAULT_OVERFLOW</span>

        <span class="n">no_wrap</span> <span class="o">=</span> <span class="n">pick_bool</span><span class="p">(</span><span class="n">no_wrap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_wrap</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">overflow</span> <span class="o">==</span> <span class="s2">&quot;ignore&quot;</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">allow_blank</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">expand_tabs</span><span class="p">(</span><span class="n">tab_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">no_wrap</span><span class="p">:</span>
                <span class="n">new_lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">([</span><span class="n">line</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="n">divide_line</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="n">wrap_overflow</span> <span class="o">==</span> <span class="s2">&quot;fold&quot;</span><span class="p">)</span>
                <span class="n">new_lines</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">rstrip_end</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wrap_justify</span><span class="p">:</span>
                <span class="n">new_lines</span><span class="o">.</span><span class="n">justify</span><span class="p">(</span>
                    <span class="n">console</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="n">wrap_justify</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="n">wrap_overflow</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="n">wrap_overflow</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lines</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the text in to given width by chopping in to lines.</span>

<span class="sd">        Args:</span>
<span class="sd">            width (int): Maximum characters in a line.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Lines: List of lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span><span class="p">:</span> <span class="n">Lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">append</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_length</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">detect_indentation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-detect indentation of code.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Number of spaces used to indent code.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_indentations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^( *)(.*)$&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">indentation</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">reduce</span><span class="p">(</span><span class="n">gcd</span><span class="p">,</span> <span class="p">[</span><span class="n">indent</span> <span class="k">for</span> <span class="n">indent</span> <span class="ow">in</span> <span class="n">_indentations</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">indent</span> <span class="o">%</span> <span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">indentation</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">indentation</span>

    <span class="k">def</span> <span class="nf">with_indent_guides</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">indent_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">character</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">StyleType</span> <span class="o">=</span> <span class="s2">&quot;dim green&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds indent guide lines to text.</span>

<span class="sd">        Args:</span>
<span class="sd">            indent_size (Optional[int]): Size of indentation, or None to auto detect. Defaults to None.</span>
<span class="sd">            character (str, optional): Character to use for indentation. Defaults to &quot;&quot;.</span>
<span class="sd">            style (Union[Style, str], optional): Style of indent guides.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Text: New text with indentation guides.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_indent_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_indentation</span><span class="p">()</span> <span class="k">if</span> <span class="n">indent_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">indent_size</span>

        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">text</span><span class="o">.</span><span class="n">expand_tabs</span><span class="p">()</span>
        <span class="n">indent_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">character</span><span class="si">}{</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">_indent_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">re_indent</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^( *)(.*)$&quot;</span><span class="p">)</span>
        <span class="n">new_lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">add_line</span> <span class="o">=</span> <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">blank_lines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">allow_blank</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re_indent</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">blank_lines</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">full_indents</span><span class="p">,</span> <span class="n">remaining_space</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">),</span> <span class="n">_indent_size</span><span class="p">)</span>
            <span class="n">new_indent</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_line</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">full_indents</span><span class="si">}{</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">remaining_space</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">line</span><span class="o">.</span><span class="n">plain</span> <span class="o">=</span> <span class="n">new_indent</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">plain</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">new_indent</span><span class="p">)</span> <span class="p">:]</span>
            <span class="n">line</span><span class="o">.</span><span class="n">stylize</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_indent</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">blank_lines</span><span class="p">:</span>
                <span class="n">new_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Text</span><span class="p">(</span><span class="n">new_indent</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)]</span> <span class="o">*</span> <span class="n">blank_lines</span><span class="p">)</span>
                <span class="n">blank_lines</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">blank_lines</span><span class="p">:</span>
            <span class="n">new_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Text</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)]</span> <span class="o">*</span> <span class="n">blank_lines</span><span class="p">)</span>

        <span class="n">new_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">blank_copy</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_text</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span> <span class="nn">rich.console</span> <span class="kn">import</span> <span class="n">Console</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;\nLorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.\n&quot;&quot;&quot;</span>
    <span class="p">)</span>
    <span class="n">text</span><span class="o">.</span><span class="n">highlight_words</span><span class="p">([</span><span class="s2">&quot;Lorem&quot;</span><span class="p">],</span> <span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">text</span><span class="o">.</span><span class="n">highlight_words</span><span class="p">([</span><span class="s2">&quot;ipsum&quot;</span><span class="p">],</span> <span class="s2">&quot;italic&quot;</span><span class="p">)</span>

    <span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>

    <span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;justify=&#39;left&#39;&quot;</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

    <span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;justify=&#39;center&#39;&quot;</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

    <span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;justify=&#39;right&#39;&quot;</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

    <span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;justify=&#39;full&#39;&quot;</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019-2022, The Firebird Project.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 6.1.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>